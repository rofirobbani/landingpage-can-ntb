<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Timeline Kegiatan - CAN BPS NTB</title>
  <link rel="icon" href="img/logo-can-title.png" type="image/png">
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
  
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Plus Jakarta Sans', 'sans-serif'] },
          colors: {
            bps: { blue: '#003366', orange: '#f57c00', green: '#2e7d32' }
          }
        }
      }
    }
  </script>

  <style>
    :root {
      --fc-border-color: #e5e7eb;
      --fc-button-bg-color: #003366;
      --fc-button-border-color: #003366;
      --fc-button-hover-bg-color: #002244;
      --fc-button-hover-border-color: #002244;
      --fc-button-active-bg-color: #f57c00;
      --fc-button-active-border-color: #f57c00;
      --fc-today-bg-color: rgba(245, 124, 0, 0.05);
    }

    .fc-event { cursor: pointer; border: none; border-radius: 4px; padding: 2px; }
    .fc-toolbar-title { font-size: 1.5rem !important; font-weight: 700; color: #1f2937; }
    .fc-daygrid-day-number { color: #374151; font-weight: 600; text-decoration: none !important; }
    .fc-col-header-cell-cushion { color: #003366; font-weight: 700; text-decoration: none !important; }
    
    /* Styling Kategori Warna Event */
    .bg-event { background-color: #003366 !important; border-left: 4px solid #0055a4 !important; }
    .bg-meeting { background-color: #2e7d32 !important; border-left: 4px solid #4caf50 !important; }
    .bg-deadline { background-color: #dc2626 !important; border-left: 4px solid #ef4444 !important; }
    .bg-holiday { background-color: #f57c00 !important; border-left: 4px solid #ff9800 !important; }
  </style>
</head>
<body class="h-full font-sans text-gray-800 bg-gray-50 flex flex-col">

  <nav id="navbar" class="fixed top-0 left-0 right-0 z-50 bg-white/95 backdrop-blur-md shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
     <div class="flex items-center justify-between h-16 md:h-20">
      <div class="flex items-center gap-6">
       <a href="index.html" class="flex items-center gap-3 group flex-shrink-0">
        <img src="img/logo-can.png" alt="Logo CAN" class="w-10 h-10 md:w-12 md:h-12 rounded-xl shadow-md object-contain bg-white">
        <div class="hidden sm:flex flex-col justify-center">
          <span class="font-bold text-bps-blue text-lg tracking-tight leading-none">CAN</span> 
          <span class="text-gray-500 text-sm font-medium leading-tight">BPS NTB</span>
        </div>
       </a>
       <div class="hidden lg:block h-8 w-px bg-gray-200"></div>
       <div class="hidden lg:flex items-center gap-4">
         <a href="https://ntb.bps.go.id" target="_blank"><img src="img/logo-bps.png" class="h-10 w-auto object-contain hover:opacity-100 transition-opacity"></a>
         <a href="#" target="_blank"><img src="img/logo-berakhlak.png" class="h-10 w-auto object-contain hover:opacity-100 transition-opacity"></a>
         <a href="#" target="_blank"><img src="img/logo-rb.png" class="h-10 w-auto object-contain hover:opacity-100 transition-opacity"></a>
         <a href="https://sensus.bps.go.id/se2026/" target="_blank"><img src="img/logo-se.png" class="h-10 w-auto object-contain hover:opacity-100 transition-opacity"></a>
       </div>
      </div>
      <div class="hidden md:flex items-center gap-8">
        <a href="index.html" class="font-medium text-gray-700 hover:text-bps-blue transition-colors">Beranda</a> 
        <a href="#" class="font-bold text-bps-blue">Timeline</a>
      </div>
      <button onclick="document.getElementById('mobile-menu').classList.toggle('hidden')" class="md:hidden p-2">
        <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
      </button>
     </div>
     <div id="mobile-menu" class="hidden md:hidden pb-4">
      <div class="flex flex-col gap-2">
        <a href="index.html" class="px-4 py-3 rounded-lg font-medium text-gray-700">Beranda</a>
        <a href="#" class="px-4 py-3 rounded-lg font-bold text-bps-blue bg-blue-50">Timeline</a>
      </div>
     </div>
    </div>
   </nav>

   <section class="pt-32 pb-10 bg-gradient-to-r from-bps-blue to-bps-green">
     <div class="max-w-7xl mx-auto px-4 text-center">
       <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-4">Kalender Kegiatan</h1>
       <p class="text-white/80 text-lg max-w-2xl mx-auto">Jadwal kegiatan, tenggat waktu, dan agenda penting Change Agent Network BPS Provinsi NTB.</p>
     </div>
   </section>

   <section class="py-12 px-4 flex-grow">
     <div class="max-w-7xl mx-auto">
       <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 border border-gray-100">
         
         <div class="mb-8 flex flex-wrap items-center justify-center gap-3 select-none">
            <span class="text-sm font-bold text-gray-500 uppercase mr-2">Filter Kategori:</span>
            
            <label class="cursor-pointer">
                <input type="checkbox" name="filterType" value="general" checked class="peer sr-only" onchange="applyFilter()">
                <div class="px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 text-gray-500 peer-checked:bg-bps-blue peer-checked:text-white transition-all shadow-sm hover:bg-gray-200 border border-transparent peer-checked:border-bps-blue ring-offset-2 peer-focus:ring-2 ring-bps-blue/50">
                    ðŸ”µ Umum
                </div>
            </label>

            <label class="cursor-pointer">
                <input type="checkbox" name="filterType" value="meeting" checked class="peer sr-only" onchange="applyFilter()">
                <div class="px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 text-gray-500 peer-checked:bg-green-600 peer-checked:text-white transition-all shadow-sm hover:bg-gray-200 border border-transparent peer-checked:border-green-600 ring-offset-2 peer-focus:ring-2 ring-green-600/50">
                    ðŸŸ¢ Rapat
                </div>
            </label>

            <label class="cursor-pointer">
                <input type="checkbox" name="filterType" value="deadline" checked class="peer sr-only" onchange="applyFilter()">
                <div class="px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 text-gray-500 peer-checked:bg-red-600 peer-checked:text-white transition-all shadow-sm hover:bg-gray-200 border border-transparent peer-checked:border-red-600 ring-offset-2 peer-focus:ring-2 ring-red-600/50">
                    ðŸ”´ Deadline
                </div>
            </label>

            <label class="cursor-pointer">
                <input type="checkbox" name="filterType" value="holiday" checked class="peer sr-only" onchange="applyFilter()">
                <div class="px-4 py-2 rounded-full text-sm font-semibold bg-gray-100 text-gray-500 peer-checked:bg-orange-500 peer-checked:text-white transition-all shadow-sm hover:bg-gray-200 border border-transparent peer-checked:border-orange-500 ring-offset-2 peer-focus:ring-2 ring-orange-500/50">
                    ðŸŸ  Libur/Cuti
                </div>
            </label>
         </div>
         <div id="loading" class="text-center py-10">
           <svg class="animate-spin h-10 w-10 text-bps-blue mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
             <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
             <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
           </svg>
           <p class="text-gray-500">Memuat data jadwal...</p>
         </div>

         <div id="calendar"></div>

       </div>
     </div>
   </section>

   <div id="eventModal" class="fixed inset-0 z-[100] hidden" aria-modal="true">
    <div class="fixed inset-0 bg-gray-900/60 backdrop-blur-sm transition-opacity" onclick="closeEventModal()"></div>
    <div class="fixed inset-0 z-10 overflow-y-auto">
     <div class="flex min-h-full items-center justify-center p-4">
      <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-2xl transition-all sm:w-full sm:max-w-md w-full">
       
       <div class="bg-bps-blue px-6 py-5 relative">
         <h3 class="text-lg font-bold text-white pr-8" id="modalTitle">Judul Kegiatan</h3>
         <button onclick="closeEventModal()" class="absolute top-4 right-4 text-white/70 hover:text-white bg-white/10 rounded-full p-1 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
         </button>
       </div>

       <div class="p-6 space-y-5">
         <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-lg bg-blue-50 flex items-center justify-center flex-shrink-0 text-bps-blue">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
            <div>
                <p class="text-xs text-gray-500 uppercase font-bold tracking-wide">Waktu Pelaksanaan</p>
                <p class="text-gray-900 font-medium mt-1" id="modalTime">-</p>
            </div>
         </div>

         <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-lg bg-orange-50 flex items-center justify-center flex-shrink-0 text-bps-orange">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
            </div>
            <div>
                <p class="text-xs text-gray-500 uppercase font-bold tracking-wide">Petugas / PIC</p>
                <p class="text-gray-900 font-medium mt-1" id="modalPetugas">-</p>
            </div>
         </div>

         <div class="flex items-start gap-3">
            <div class="w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center flex-shrink-0 text-gray-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" /></svg>
            </div>
            <div>
                <p class="text-xs text-gray-500 uppercase font-bold tracking-wide">Deskripsi</p>
                <div class="text-gray-600 text-sm mt-1 leading-relaxed whitespace-pre-line" id="modalDesc">-</div>
            </div>
         </div>

         <div class="pt-2 border-t border-gray-100">
           <span id="modalType" class="inline-flex items-center px-3 py-1 rounded-full text-xs font-bold text-white bg-gray-500">General</span>
         </div>
       </div>

       <div class="bg-gray-50 px-6 py-3 flex justify-end">
         <button type="button" class="inline-flex justify-center rounded-lg border border-transparent bg-bps-blue px-5 py-2 text-sm font-medium text-white hover:bg-bps-blue-light transition-colors shadow-sm" onclick="closeEventModal()">Tutup</button>
       </div>
      </div>
     </div>
    </div>
   </div>

   <footer class="bg-bps-blue py-8 mt-auto">
    <div class="text-center text-white/60 text-sm">
      <p>Â© 2026 Change Agent Network BPS Provinsi NTB.</p>
    </div>
   </footer>

   <script>
    // Variable Global untuk menyimpan Calendar dan Events
    let calendar;
    let allEvents = []; 

    async function loadExcelData() {
      try {
        const response = await fetch('data/jadwal.xlsx'); 
        
        if (!response.ok) {
            console.error("Gagal load excel");
            return [];
        }

        console.log("âœ… File ditemukan. Membaca isi..."); // DEBUG 2

        const arrayBuffer = await response.arrayBuffer();
        const workbook = XLSX.read(arrayBuffer, { type: 'array' });
        const firstSheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[firstSheetName];
        
        const rawData = XLSX.utils.sheet_to_json(worksheet, { cellDates: true });

        console.log("ðŸ“Š Data Mentah dari Excel:", rawData);
        
        return rawData.map(item => {
          let className = 'bg-event'; 
          // Normalisasi tipe agar tidak case sensitive (Misal "Meeting" jadi "meeting")
          const typeLower = (item.type || 'general').toLowerCase().trim();

          if (typeLower === 'meeting') className = 'bg-meeting'; 
          if (typeLower === 'deadline') className = 'bg-deadline'; 
          if (typeLower === 'holiday') className = 'bg-holiday'; 

          return {
            title: item.title,
            start: item.start,
            end: item.end || item.start,
            extendedProps: {
              description: item.description || '-',
              // Simpan tipe yang dinormalisasi untuk keperluan filtering
              filterType: typeLower === 'general' ? 'general' : typeLower,
              // Simpan tipe asli untuk ditampilkan di modal (agar huruf besar/kecil sesuai excel)
              type: item.type || 'General',
              petugas: item.petugas || '-'
            },
            className: className
          };
        });

      } catch (error) {
        console.error("Error:", error);
        return [];
      }
    }

    // Fungsi Filtering
    function applyFilter() {
        if (!calendar) return;

        // 1. Ambil semua checkbox yang dicentang
        const checkboxes = document.querySelectorAll('input[name="filterType"]:checked');
        const activeFilters = Array.from(checkboxes).map(cb => cb.value);

        // 2. Filter data dari allEvents
        const filteredEvents = allEvents.filter(event => {
            const eventType = event.extendedProps.filterType;
            
            // Cek apakah tipe event ini ada di daftar filter yang aktif
            if (activeFilters.includes(eventType)) return true;
            
            // Fallback: Jika event punya tipe yang tidak dikenal (misal typo di excel), anggap General
            // Tapi hanya tampilkan jika checkbox "general" dicentang
            const knownTypes = ['meeting', 'deadline', 'holiday'];
            if (activeFilters.includes('general') && !knownTypes.includes(eventType)) return true;

            return false;
        });

        // 3. Update Kalender: Hapus semua, lalu masukkan yang lolos filter
        calendar.removeAllEvents();
        calendar.addEventSource(filteredEvents);
    }

    document.addEventListener('DOMContentLoaded', async function() {
      const calendarEl = document.getElementById('calendar');
      const loadingEl = document.getElementById('loading');

      // Load data ke variabel global dulu
      allEvents = await loadExcelData();
      loadingEl.style.display = 'none';

      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,listMonth'
        },
        buttonText: {
          today: 'Hari Ini',
          month: 'Bulan',
          week: 'Minggu',
          list: 'Agenda'
        },
        locale: 'id',
        // Kita mulai dengan menampilkan semua event (sebelum filter berjalan)
        events: allEvents,
        eventTimeFormat: { 
            hour: '2-digit',
            minute: '2-digit',
            meridiem: false
        },
        eventClick: function(info) {
          showEventModal(info.event);
        },
        height: 'auto',
        aspectRatio: 1.8,
        dayMaxEvents: true 
      });

      calendar.render();
      
      // Jalankan filter sekali di awal untuk memastikan tampilan sesuai checkbox default
      applyFilter();
    });

    function showEventModal(event) {
      document.getElementById('modalTitle').innerText = event.title;
      
      const optionsDate = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const optionsTime = { hour: '2-digit', minute: '2-digit' };
      
      const startDate = event.start;
      const endDate = event.end;

      let dateString = startDate.toLocaleDateString('id-ID', optionsDate);
      
      if (startDate.getHours() !== 0 || startDate.getMinutes() !== 0) {
        dateString += ` â€¢ ${startDate.toLocaleTimeString('id-ID', optionsTime)}`;
        if (endDate && endDate.getDate() === startDate.getDate()) {
            dateString += ` - ${endDate.toLocaleTimeString('id-ID', optionsTime)}`;
        }
      }

      document.getElementById('modalTime').innerText = dateString;
      document.getElementById('modalDesc').innerText = event.extendedProps.description;
      document.getElementById('modalPetugas').innerText = event.extendedProps.petugas;
      
      const typeEl = document.getElementById('modalType');
      const typeText = event.extendedProps.type;
      typeEl.innerText = typeText.toUpperCase();
      
      typeEl.className = 'inline-flex items-center px-3 py-1 rounded-full text-xs font-bold text-white';
      
      if (event.classNames.includes('bg-meeting')) typeEl.classList.add('bg-green-600');
      else if (event.classNames.includes('bg-deadline')) typeEl.classList.add('bg-red-600');
      else if (event.classNames.includes('bg-holiday')) typeEl.classList.add('bg-orange-500');
      else typeEl.classList.add('bg-bps-blue');

      document.getElementById('eventModal').classList.remove('hidden');
    }

    function closeEventModal() {
      document.getElementById('eventModal').classList.add('hidden');
    }
   </script>

</body>
</html>